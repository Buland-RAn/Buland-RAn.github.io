<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>è·Ÿç€åšä¸€ä¸ªJSONè§£æå™¨ï¼ˆå…­ï¼‰ | AYu</title>
  <meta name="author" content="AYu">
  
  <meta name="description" content="å­¦ä¹ ç”Ÿæ´»ç‰‡æ®µè®°å½•">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="è·Ÿç€åšä¸€ä¸ªJSONè§£æå™¨ï¼ˆå…­ï¼‰"/>
  <meta property="og:site_name" content="AYu"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.ico" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70812759-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cb5448498d7169c668b07c2b255d62c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 5.0.2"><link rel="alternate" href="atom.xml" title="AYu" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">AYu</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archive" title="All the articles.">
			  <i class=""></i>Archive
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> è·Ÿç€åšä¸€ä¸ªJSONè§£æå™¨ï¼ˆå…­ï¼‰</h1>
		</div>
	


<script src='//unpkg.com/valine/dist/Valine.min.js'></script>

<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>è·Ÿç€githubä¸Šçš„é¡¹ç›®json-tutorialå®Œæˆä¸€ä¸ªjsonè§£æå™¨ã€‚æœ¬æ–‡å¯¹åº”è¯¥é¡¹ç›®çš„ç¬¬å››å•å…ƒï¼Œé‡ç‚¹åœ¨è§£æjsonå¯¹è±¡ç±»å‹ã€‚<a id="more"></a></p>
<p>ğŸ‘‰<a target="_blank" rel="noopener" href="https://github.com/miloyip/json-tutorial">åŸé¡¹ç›®åœ°å€</a></p>
<h1 id="ä¸€ã€JSON-å¯¹è±¡"><a href="#ä¸€ã€JSON-å¯¹è±¡" class="headerlink" title="ä¸€ã€JSON å¯¹è±¡"></a>ä¸€ã€JSON å¯¹è±¡</h1><p>æ­¤å•å…ƒæ˜¯æœ¬æ•™ç¨‹æœ€åä¸€ä¸ªå…³äº JSON è§£æå™¨çš„éƒ¨åˆ†ã€‚JSON å¯¹è±¡å’Œ JSON æ•°ç»„éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«åŒ…æ‹¬ JSON å¯¹è±¡ä»¥èŠ±æ‹¬å· <code>&#123;&#125;</code>ï¼ˆ<code>U+007B</code>ã€<code>U+007D</code>ï¼‰åŒ…è£¹è¡¨ç¤ºï¼Œå¦å¤– JSON å¯¹è±¡ç”±å¯¹è±¡æˆå‘˜ï¼ˆmemberï¼‰ç»„æˆï¼Œè€Œ JSON æ•°ç»„ç”± JSON å€¼ç»„æˆã€‚æ‰€è°“å¯¹è±¡æˆå‘˜ï¼Œå°±æ˜¯é”®å€¼å¯¹ï¼Œé”®å¿…é¡»ä¸º JSON å­—ç¬¦ä¸²ï¼Œç„¶åå€¼æ˜¯ä»»ä½• JSON å€¼ï¼Œä¸­é—´ä»¥å†’å· <code>:</code>ï¼ˆ<code>U+003A</code>ï¼‰åˆ†éš”ã€‚å®Œæ•´è¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">member = <span class="built_in">string</span> <span class="keyword">ws</span> %x3A <span class="keyword">ws</span> value</span><br><span class="line">object = %x7B <span class="keyword">ws</span> [ member *( <span class="keyword">ws</span> %x2C <span class="keyword">ws</span> member ) ] <span class="keyword">ws</span> %x7D</span><br></pre></td></tr></table></figure>



<h1 id="äºŒã€æ•°æ®ç»“æ„"><a href="#äºŒã€æ•°æ®ç»“æ„" class="headerlink" title="äºŒã€æ•°æ®ç»“æ„"></a>äºŒã€æ•°æ®ç»“æ„</h1><p>è¦è¡¨ç¤ºé”®å€¼å¯¹çš„é›†åˆï¼Œæœ‰å¾ˆå¤šæ•°æ®ç»“æ„å¯ä¾›é€‰æ‹©ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>åŠ¨æ€æ•°ç»„ï¼ˆdynamic arrayï¼‰ï¼šå¯æ‰©å±•å®¹é‡çš„æ•°ç»„ï¼Œå¦‚ C++ çš„ <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/container/vector"><code>std::vector</code></a>ã€‚</li>
<li>æœ‰åºåŠ¨æ€æ•°ç»„ï¼ˆsorted dynamic arrayï¼‰ï¼šå’ŒåŠ¨æ€æ•°ç»„ç›¸åŒï¼Œä½†ä¿è¯å…ƒç´ å·²æ’åºï¼Œå¯ç”¨äºŒåˆ†æœå¯»æŸ¥è¯¢æˆå‘˜ã€‚</li>
<li>å¹³è¡¡æ ‘ï¼ˆbalanced treeï¼‰ï¼šå¹³è¡¡äºŒå‰æ ‘å¯æœ‰åºåœ°éå†æˆå‘˜ï¼Œå¦‚çº¢é»‘æ ‘å’Œ C++ çš„ <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/container/map"><code>std::map</code></a>ï¼ˆ<a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/container/multimap"><code>std::multi_map</code></a> æ”¯æŒé‡å¤é”®ï¼‰ã€‚</li>
<li>å“ˆå¸Œè¡¨ï¼ˆhash tableï¼‰ï¼šé€šè¿‡å“ˆå¸Œå‡½æ•°èƒ½å®ç°å¹³å‡ O(1) æŸ¥è¯¢ï¼Œå¦‚ C++11 çš„ <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/container/unordered_map"><code>std::unordered_map</code></a>ï¼ˆ<a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/container/unordered_multimap"><code>unordered_multimap</code></a> æ”¯æŒé‡å¤é”®ï¼‰ã€‚</li>
</ul>
<p>è®¾ä¸€ä¸ªå¯¹è±¡æœ‰ n ä¸ªæˆå‘˜ï¼Œæ•°æ®ç»“æ„çš„å®¹é‡æ˜¯ mï¼Œn â©½ mï¼Œé‚£ä¹ˆä¸€äº›å¸¸ç”¨æ“ä½œçš„æ—¶é—´ï¼ç©ºé—´å¤æ‚åº¦å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>åŠ¨æ€æ•°ç»„</th>
<th>æœ‰åºåŠ¨æ€æ•°ç»„</th>
<th>å¹³è¡¡æ ‘</th>
<th>å“ˆå¸Œè¡¨</th>
</tr>
</thead>
<tbody><tr>
<td>æœ‰åº</td>
<td>å¦</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
<td>å¦</td>
</tr>
<tr>
<td>è‡ªå®šæˆå‘˜æ¬¡åº</td>
<td>å¯</td>
<td>å¦</td>
<td>å¦</td>
<td>å¦</td>
</tr>
<tr>
<td>åˆå§‹åŒ– n ä¸ªæˆå‘˜</td>
<td>O(n)</td>
<td>O(n log n)</td>
<td>O(n log n)</td>
<td>å¹³å‡ O(n)ã€æœ€å O(n^2)</td>
</tr>
<tr>
<td>åŠ å…¥æˆå‘˜</td>
<td>åˆ†æ‘Š O(1)</td>
<td>O(n)</td>
<td>O(log n)</td>
<td>å¹³å‡ O(1)ã€æœ€å O(n)</td>
</tr>
<tr>
<td>ç§»é™¤æˆå‘˜</td>
<td>O(n)</td>
<td>O(n)</td>
<td>O(log n)</td>
<td>å¹³å‡ O(1)ã€æœ€å O(n)</td>
</tr>
<tr>
<td>æŸ¥è¯¢æˆå‘˜</td>
<td>O(n)</td>
<td>O(log n)</td>
<td>O(log n)</td>
<td>å¹³å‡ O(1)ã€æœ€å O(n)</td>
</tr>
<tr>
<td>éå†æˆå‘˜</td>
<td>O(n)</td>
<td>O(n)</td>
<td>O(n)</td>
<td>O(m)</td>
</tr>
<tr>
<td>æ£€æµ‹å¯¹è±¡ç›¸ç­‰</td>
<td>O(n^2)</td>
<td>O(n)</td>
<td>O(n)</td>
<td>å¹³å‡ O(n)ã€æœ€å O(n^2)</td>
</tr>
<tr>
<td>ç©ºé—´</td>
<td>O(m)</td>
<td>O(m)</td>
<td>O(n)</td>
<td>O(m)</td>
</tr>
</tbody></table>
<p>åœ¨ ECMA-404 æ ‡å‡†ä¸­ï¼Œå¹¶æ²¡æœ‰è§„å®šå¯¹è±¡ä¸­æ¯ä¸ªæˆå‘˜çš„é”®ä¸€å®šè¦å”¯ä¸€çš„ï¼Œä¹Ÿæ²¡æœ‰è§„å®šæ˜¯å¦éœ€è¦ç»´æŒæˆå‘˜çš„æ¬¡åºã€‚</p>
<p>ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬çš„ leptjson é€‰æ‹©ç”¨åŠ¨æ€æ•°ç»„çš„æ–¹æ¡ˆã€‚æˆ‘ä»¬å°†åœ¨å•å…ƒå…«æ‰åŠ å…¥åŠ¨æ€åŠŸèƒ½ï¼Œæ‰€ä»¥è¿™å•å…ƒä¸­ï¼Œæ¯ä¸ªå¯¹è±¡ä»…ä»…æ˜¯æˆå‘˜çš„æ•°ç»„ã€‚é‚£ä¹ˆå®ƒè·Ÿä¸Šä¸€å•å…ƒçš„æ•°ç»„éå¸¸æ¥è¿‘ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">lept_value</span> <span class="title">lept_value</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">lept_member</span> <span class="title">lept_member</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lept_value</span> &#123;</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span> lept_member* m; <span class="keyword">size_t</span> size; &#125;o;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span> lept_value* e; <span class="keyword">size_t</span> size; &#125;a;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="keyword">char</span>* s; <span class="keyword">size_t</span> len; &#125;s;</span><br><span class="line">        <span class="keyword">double</span> n;</span><br><span class="line">    &#125;u;</span><br><span class="line">    lept_type type;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lept_member</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span>* k; <span class="keyword">size_t</span> klen;   <span class="comment">/* member key string, key string length */</span></span><br><span class="line">    lept_value v;           <span class="comment">/* member value */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æˆå‘˜ç»“æ„ <code>lept_member</code> æ˜¯ä¸€ä¸ª <code>lept_value</code> åŠ ä¸Šé”®çš„å­—ç¬¦ä¸²ã€‚å¦‚åŒ JSON å­—ç¬¦ä¸²çš„å€¼ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦åŒæ—¶ä¿ç•™å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå› ä¸ºå­—ç¬¦ä¸²æœ¬èº«å¯èƒ½åŒ…å«ç©ºå­—ç¬¦ <code>\u0000</code>ã€‚</p>
<p>åœ¨è¿™å•å…ƒä¸­ï¼Œæˆ‘ä»¬ä»…æ·»åŠ äº†æœ€åŸºæœ¬çš„è®¿é—®å‡½æ•°ï¼Œç”¨äºæ’°å†™å•å…ƒæµ‹è¯•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">lept_get_object_size</span><span class="params">(<span class="keyword">const</span> lept_value* v)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">lept_get_object_key</span><span class="params">(<span class="keyword">const</span> lept_value* v, <span class="keyword">size_t</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">lept_get_object_key_length</span><span class="params">(<span class="keyword">const</span> lept_value* v, <span class="keyword">size_t</span> index)</span></span>;</span><br><span class="line"><span class="function">lept_value* <span class="title">lept_get_object_value</span><span class="params">(<span class="keyword">const</span> lept_value* v, <span class="keyword">size_t</span> index)</span></span>;</span><br></pre></td></tr></table></figure>

<p>åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè®¸å¤šæ—¶å€™ï¼Œé€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„åå·²ç­‰äºå®Œæˆä¸€åŠå·¥ä½œã€‚æ²¡æœ‰å®Œç¾çš„æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥æœ€å¥½è€ƒè™‘å¤šä¸€äº›åº”ç”¨çš„åœºåˆï¼Œçœ‹çœ‹æ—¶é—´ï¼ç©ºé—´å¤æ‚åº¦ä»¥è‡³ç›¸å…³ç³»æ•°æ˜¯å¦åˆé€‚ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç€æ‰‹å®ç°ã€‚</p>
<h1 id="ä¸‰ã€é‡æ„å­—ç¬¦ä¸²è§£æ"><a href="#ä¸‰ã€é‡æ„å­—ç¬¦ä¸²è§£æ" class="headerlink" title="ä¸‰ã€é‡æ„å­—ç¬¦ä¸²è§£æ"></a>ä¸‰ã€é‡æ„å­—ç¬¦ä¸²è§£æ</h1><p>åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œ<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BB%A3%E7%A0%81%E9%87%8D%E6%9E%84">ä»£ç é‡æ„</a>ï¼ˆcode refactoringï¼‰æ˜¯æŒ‡åœ¨ä¸æ”¹å˜è½¯ä»¶å¤–åœ¨è¡Œä¸ºæ—¶ï¼Œä¿®æ”¹ä»£ç ä»¥æ”¹è¿›ç»“æ„ã€‚ä»£ç é‡æ„ååˆ†ä¾èµ–äºå•å…ƒæµ‹è¯•ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯é€šè¿‡å•å…ƒæµ‹è¯•å»ç»´æŠ¤ä»£ç çš„æ­£ç¡®æ€§ã€‚æœ‰äº†è¶³å¤Ÿçš„å•å…ƒæµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾èƒ†å»é‡æ„ï¼Œå°è¯•å¹¶è¯„ä¼°ä¸åŒçš„æ”¹è¿›æ–¹å¼ï¼Œæ‰¾åˆ°åˆä¹å¿ƒæ„è€Œä¸”èƒ½é€šè¿‡å•å…ƒæµ‹è¯•çš„æ”¹åŠ¨ï¼Œæˆ‘ä»¬æ‰æäº¤å®ƒã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œæˆå‘˜çš„é”®ä¹Ÿæ˜¯ä¸€ä¸ª JSON å­—ç¬¦ä¸²ï¼Œç„¶è€Œï¼Œæˆ‘ä»¬ä¸ä½¿ç”¨ <code>lept_value</code> å­˜å‚¨é”®ï¼Œå› ä¸ºè¿™æ ·ä¼šæµªè´¹äº†å½“ä¸­ <code>type</code> è¿™ä¸ªæ— ç”¨çš„å­—æ®µã€‚ç”±äº <code>lept_parse_string()</code> æ˜¯ç›´æ¥åœ°æŠŠè§£æçš„ç»“æœå†™è¿›ä¸€ä¸ª <code>lept_value</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆç”¨ã€Œæå–æ–¹æ³•ï¼ˆextract methodï¼Œè§ä¸‹æ³¨ï¼‰ã€çš„é‡æ„æ–¹å¼ï¼ŒæŠŠè§£æ JSON å­—ç¬¦ä¸²åŠå†™å…¥ <code>lept_value</code> åˆ†æ‹†æˆä¸¤éƒ¨åˆ†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è§£æ JSON å­—ç¬¦ä¸²ï¼ŒæŠŠç»“æœå†™å…¥ str å’Œ len */</span></span><br><span class="line"><span class="comment">/* str æŒ‡å‘ c-&gt;stack ä¸­çš„å…ƒç´ ï¼Œéœ€è¦åœ¨ c-&gt;stack  */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lept_parse_string_raw</span><span class="params">(lept_context* c, <span class="keyword">char</span>** str, <span class="keyword">size_t</span>* len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* \todo */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lept_parse_string</span><span class="params">(lept_context* c, lept_value* v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">char</span>* s;</span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">if</span> ((ret = lept_parse_string_raw(c, &amp;s, &amp;len)) == LEPT_PARSE_OK)</span><br><span class="line">        lept_set_string(v, s, len);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å®ç°å¯¹è±¡çš„è§£ææ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>lept_parse_string_raw()</code>ã€€æ¥è§£æ JSON å­—ç¬¦ä¸²ï¼Œç„¶åæŠŠç»“æœå¤åˆ¶è‡³ <code>lept_member</code> çš„ <code>k</code> å’Œ <code>klen</code> å­—æ®µã€‚</p>
<p>æ³¨ï¼šåœ¨ Fowler çš„ç»å…¸è‘—ä½œ [1] ä¸­ï¼ŒæŠŠå„ç§é‡æ„æ–¹å¼åˆ†é—¨åˆ«ç±»ï¼Œæ¯ä¸ªæ–¹å¼éƒ½æœ‰è¯¦ç»†çš„æ­¥éª¤è¯´æ˜ã€‚ç”±äºä¹¦ä¸­ä»¥ Java ä¸ºä¾‹å­ï¼Œæ‰€ä»¥æ–¹å¼çš„åç§°ä½¿ç”¨äº† Java çš„è¿°è¯­ï¼Œä¾‹å¦‚æ–¹æ³•ï¼ˆmethodï¼‰ã€‚åœ¨ C è¯­è¨€ä¸­ï¼Œã€Œæå–æ–¹æ³•ã€å…¶å®åº”è¯¥ç§°ä¸ºã€Œæå–å‡½æ•°ã€ã€‚</p>
<p>[1] Fowler, Martin. Refactoring: improving the design of existing code. Pearson Education India, 2009. ä¸­è¯‘æœ¬ï¼šç†ŠèŠ‚è¯‘ï¼Œã€Šé‡æ„â€”â€”æ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ã€‹ï¼Œäººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾ï¼Œ2010å¹´ã€‚</p>
<h1 id="å››ã€å®ç°"><a href="#å››ã€å®ç°" class="headerlink" title="å››ã€å®ç°"></a>å››ã€å®ç°</h1><p>è§£æå¯¹è±¡ä¸è§£ææ•°ç»„éå¸¸ç›¸ä¼¼ï¼Œæ‰€ä»¥æˆ‘ç•™ç©ºäº†å‡ æ®µä½œä¸ºç»ƒä¹ ã€‚åœ¨è§£ææ•°ç»„æ—¶ï¼Œæˆ‘ä»¬æŠŠå½“å‰çš„å…ƒç´ ä»¥ <code>lept_value</code> å‹å…¥æ ˆä¸­ï¼Œè€Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ™æ˜¯ä»¥ <code>lept_member</code> å‹å…¥ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lept_parse_object</span><span class="params">(lept_context* c, lept_value* v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    lept_member m;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    EXPECT(c, <span class="string">&#x27;&#123;&#x27;</span>);</span><br><span class="line">    lept_parse_whitespace(c);</span><br><span class="line">    <span class="keyword">if</span> (*c-&gt;json == <span class="string">&#x27;&#125;&#x27;</span>) &#123;</span><br><span class="line">        c-&gt;json++;</span><br><span class="line">        v-&gt;type = LEPT_OBJECT;</span><br><span class="line">        v-&gt;u.o.m = <span class="number">0</span>;</span><br><span class="line">        v-&gt;u.o.size = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> LEPT_PARSE_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    m.k = <span class="literal">NULL</span>;</span><br><span class="line">    size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        lept_init(&amp;m.v);</span><br><span class="line">        <span class="comment">/* \todo parse key to m.k, m.klen */</span></span><br><span class="line">        <span class="comment">/* \todo parse ws colon ws */</span></span><br><span class="line">        <span class="comment">/* parse value */</span></span><br><span class="line">        <span class="keyword">if</span> ((ret = lept_parse_value(c, &amp;m.v)) != LEPT_PARSE_OK)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(lept_context_push(c, <span class="keyword">sizeof</span>(lept_member)), &amp;m, <span class="keyword">sizeof</span>(lept_member));</span><br><span class="line">        size++;</span><br><span class="line">        m.k = <span class="literal">NULL</span>; <span class="comment">/* ownership is transferred to member on stack */</span></span><br><span class="line">        <span class="comment">/* \todo parse ws [comma | right-curly-brace] ws */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* \todo Pop and free members on the stack */</span></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬è¦ä¸º <code>m.k</code> åˆ†é…å†…å­˜å»å­˜å‚¨é”®çš„å­—ç¬¦ä¸²ï¼Œè‹¥åœ¨æ•´ä¸ªå¯¹è±¡è§£ææ—¶å‘ç”Ÿé”™è¯¯ï¼Œä¹Ÿè¦è®°å¾—é‡Šæ”¾æ ˆä¸­çš„ <code>lept_member</code> çš„ <code>k</code>ã€‚</p>
<p>æˆ‘ä»¬ä¸ºè§£æå¯¹è±¡å®šä¹‰äº†å‡ ä¸ªæ–°çš„é”™è¯¯ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">    LEPT_PARSE_MISS_KEY,</span><br><span class="line">    LEPT_PARSE_MISS_COLON,</span><br><span class="line">    LEPT_PARSE_MISS_COMMA_OR_CURLY_BRACKET</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨æ­¤ä¸å†èµ˜è¿°å®ƒä»¬çš„æ„ä¹‰äº†ï¼Œå¯ä»ä»¥ä¸‹çš„å•å…ƒæµ‹è¯•çœ‹åˆ°ä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test_parse_miss_key</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_KEY, <span class="string">&quot;&#123;:1,&quot;</span>);</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_KEY, <span class="string">&quot;&#123;1:1,&quot;</span>);</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_KEY, <span class="string">&quot;&#123;true:1,&quot;</span>);</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_KEY, <span class="string">&quot;&#123;false:1,&quot;</span>);</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_KEY, <span class="string">&quot;&#123;null:1,&quot;</span>);</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_KEY, <span class="string">&quot;&#123;[]:1,&quot;</span>);</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_KEY, <span class="string">&quot;&#123;&#123;&#125;:1,&quot;</span>);</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_KEY, <span class="string">&quot;&#123;\&quot;a\&quot;:1,&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test_parse_miss_colon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_COLON, <span class="string">&quot;&#123;\&quot;a\&quot;&#125;&quot;</span>);</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_COLON, <span class="string">&quot;&#123;\&quot;a\&quot;,\&quot;b\&quot;&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test_parse_miss_comma_or_curly_bracket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_COMMA_OR_CURLY_BRACKET, <span class="string">&quot;&#123;\&quot;a\&quot;:1&quot;</span>);</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_COMMA_OR_CURLY_BRACKET, <span class="string">&quot;&#123;\&quot;a\&quot;:1]&quot;</span>);</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_COMMA_OR_CURLY_BRACKET, <span class="string">&quot;&#123;\&quot;a\&quot;:1 \&quot;b\&quot;&quot;</span>);</span><br><span class="line">    TEST_ERROR(LEPT_PARSE_MISS_COMMA_OR_CURLY_BRACKET, <span class="string">&quot;&#123;\&quot;a\&quot;:&#123;&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="äº”ã€æ€»ç»“ä¸ç»ƒä¹ "><a href="#äº”ã€æ€»ç»“ä¸ç»ƒä¹ " class="headerlink" title="äº”ã€æ€»ç»“ä¸ç»ƒä¹ "></a>äº”ã€æ€»ç»“ä¸ç»ƒä¹ </h1><p>åœ¨æœ¬å•å…ƒä¸­ï¼Œé™¤äº†è°ˆåŠ JSON å¯¹è±¡çš„è¯­æ³•ã€å¯é€‰çš„æ•°æ®ç»“æ„ã€å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬ä¹Ÿè½»è½»è°ˆåŠäº†é‡æ„çš„æ¦‚å¿µã€‚æœ‰èµ–äºæµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTDDï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä¸æ–­é‡å¡‘è½¯ä»¶çš„å†…éƒ¨ç»“æ„ã€‚</p>
<p>å®Œæˆè¿™æ¬¡ç»ƒä¹ ä¹‹åï¼Œæ­å–œä½ ï¼Œä½ å·²ç»å®Œæ•´åœ°å®ç°äº†ä¸€ä¸ªç¬¦åˆæ ‡å‡†çš„ JSON è§£æå™¨äº†ã€‚ä¹‹åæˆ‘ä»¬ä¼šå®Œæˆæ›´ç®€å•çš„ç”Ÿæˆå™¨åŠå…¶ä»–è®¿é—®åŠŸèƒ½ã€‚</p>
<p>ç”±äºå¯¹è±¡å’Œæ•°ç»„çš„ç›¸ä¼¼æ€§ï¼Œæ­¤å•å…ƒç•™ç©ºäº†è¾ƒå¤šå®ç°éƒ¨åˆ†ä½œä¸ºç»ƒä¹ ï¼š</p>
<ol>
<li>ä¾ç¬¬ 3 èŠ‚æ‰€è¿°ï¼Œé‡æ„ <code>lept_parse_string()</code>ã€‚é‡æ„å‰è¿è¡Œå•å…ƒæµ‹è¯•ï¼Œé‡æ„åç¡®ä¿å•å…ƒæµ‹è¯•ä»ä¿æŒé€šè¿‡ã€‚</li>
</ol>
<p>è¿™ä¸ªã€Œæå–æ–¹æ³•ã€é‡æ„ç»ƒä¹ å¾ˆç®€å•ï¼Œåªéœ€è¦æŠŠåŸæ¥è°ƒç”¨ <code>lept_set_string</code> çš„åœ°æ–¹ï¼Œæ”¹ä¸ºå†™å…¥å‚æ•°å˜é‡ã€‚å› æ­¤ï¼ŒåŸæ¥çš„ <code>lept_parse_string()</code> å’Œ ç­”æ¡ˆä¸­çš„ <code>lept_parse_string_raw()</code> çš„ diff ä»…æ˜¯ä¸¤å¤„ï¼š</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">130</span>,<span class="number">131</span>c130,<span class="number">131</span></span><br><span class="line">&lt; static <span class="built_in">int</span> lept<span class="constructor">_parse_string(<span class="params">lept_context</span><span class="operator">*</span> <span class="params">c</span>, <span class="params">lept_value</span><span class="operator">*</span> <span class="params">v</span>)</span> &#123;</span><br><span class="line">&lt;     size_t head = c-&gt;top, len;</span><br><span class="line">---</span><br><span class="line">&gt; static <span class="built_in">int</span> lept<span class="constructor">_parse_string_raw(<span class="params">lept_context</span><span class="operator">*</span> <span class="params">c</span>, <span class="params">char</span><span class="operator">**</span> <span class="params">str</span>, <span class="params">size_t</span><span class="operator">*</span> <span class="params">len</span>)</span> &#123;</span><br><span class="line">&gt;     size_t head = c-&gt;top;</span><br><span class="line"><span class="number">140</span>,<span class="number">141</span>c140,<span class="number">141</span></span><br><span class="line">&lt;                 len = c-&gt;top - head;</span><br><span class="line">&lt;                 lept<span class="constructor">_set_string(<span class="params">v</span>, (<span class="params">const</span> <span class="params">char</span><span class="operator">*</span>)</span>lept<span class="constructor">_context_pop(<span class="params">c</span>, <span class="params">len</span>)</span>, len);</span><br><span class="line">---</span><br><span class="line">&gt;                 *len = c-&gt;top - head;</span><br><span class="line">&gt;                 *str = lept<span class="constructor">_context_pop(<span class="params">c</span>, <span class="operator">*</span><span class="params">len</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>ä»¥ TDD æ–¹å¼å¼€å‘è½¯ä»¶ï¼Œå› ä¸ºæœ‰å•å…ƒæµ‹è¯•ç¡®ä¿è½¯ä»¶çš„æ­£ç¡®æ€§ï¼Œé¢å¯¹æ–°éœ€æ±‚å¯ä»¥å®‰å¿ƒé‡æ„ï¼Œæ”¹å–„è½¯ä»¶æ¶æ„ã€‚</p>
<ol start="2">
<li>æ‰“å¼€ <code>test.c</code> ä¸­ä¸¤ä¸ª <code>#if 0</code>ï¼Œè¿è¡Œå•å…ƒæµ‹è¯•ï¼Œè¯å®å•å…ƒæµ‹è¯•ä¸é€šè¿‡ã€‚ç„¶åå®ç° <code>lept_parse_object()</code> ä¸­çš„ <code>\todo</code> éƒ¨åˆ†ã€‚éªŒè¯å®ç°èƒ½é€šè¿‡å•å…ƒæµ‹è¯•ã€‚</li>
</ol>
<p>æœ‰äº† <code>lept_parse_array()</code> çš„ç»éªŒï¼Œå®ç° <code>lept_parse_object()</code> å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œåˆ†åˆ«åªæ˜¯æ¯ä¸ªè¿­ä»£è¦å¤šå¤„ç†ä¸€ä¸ªé”®å’Œå†’å·ã€‚æˆ‘ä»¬æŠŠè¿™ä¸ªå®ç°è¿‡ç¨‹åˆ†ä¸º 5 æ­¥æ›²ã€‚</p>
<p>ç¬¬ 1 æ­¥æ˜¯åˆ©ç”¨åˆšæ‰é‡æ„å‡ºæ¥çš„ <code>lept_parse_string_raw()</code> å»è§£æé”®çš„å­—ç¬¦ä¸²ã€‚ç”±äº <code>lept_parse_string_raw()</code> å‡è®¾ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸º <code>&quot;</code>ï¼Œæˆ‘ä»¬è¦å…ˆä½œæ ¡æ£€ï¼Œå¤±è´¥åˆ™è¦è¿”å› <code>LEPT_PARSE_MISS_KEY</code> é”™è¯¯ã€‚è‹¥å­—ç¬¦ä¸²è§£ææˆåŠŸï¼Œå®ƒä¼šæŠŠç»“æœå­˜å‚¨åœ¨æˆ‘ä»¬çš„æ ˆä¹‹ä¸­ï¼Œéœ€è¦æŠŠç»“æœå†™å…¥ä¸´æ—¶ <code>lept_member</code> çš„ <code>k</code> å’Œ <code>klen</code> å­—æ®µä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lept_parse_object</span><span class="params">(lept_context* c, lept_value* v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> i, size;</span><br><span class="line">    lept_member m;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">    m.k = <span class="literal">NULL</span>;</span><br><span class="line">    size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">char</span>* str;</span><br><span class="line">        lept_init(&amp;m.v);</span><br><span class="line">        <span class="comment">/* 1. parse key */</span></span><br><span class="line">        <span class="keyword">if</span> (*c-&gt;json != <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">            ret = LEPT_PARSE_MISS_KEY;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((ret = lept_parse_string_raw(c, &amp;str, &amp;m.klen)) != LEPT_PARSE_OK)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(m.k = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(m.klen + <span class="number">1</span>), str, m.klen);</span><br><span class="line">        m.k[m.klen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="comment">/* 2. parse ws colon ws */</span></span><br><span class="line">        <span class="comment">/* ... */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 5. Pop and free members on the stack */</span></span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 2 æ­¥æ˜¯è§£æå†’å·ï¼Œå†’å·å‰åå¯æœ‰ç©ºç™½å­—ç¬¦ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 2. parse ws colon ws */</span></span><br><span class="line">lept_parse_whitespace(c);</span><br><span class="line"><span class="keyword">if</span> (*c-&gt;json != <span class="string">&#x27;:&#x27;</span>) &#123;</span><br><span class="line">    ret = LEPT_PARSE_MISS_COLON;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">c-&gt;json++;</span><br><span class="line">lept_parse_whitespace(c);</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 3 æ­¥æ˜¯è§£æä»»æ„çš„ JSON å€¼ã€‚è¿™éƒ¨åˆ†ä¸è§£ææ•°ç»„ä¸€æ ·ï¼Œé€’å½’è°ƒç”¨ <code>lept_parse_value()</code>ï¼ŒæŠŠç»“æœå†™å…¥ä¸´æ—¶ <code>lept_member</code> çš„ <code>v</code> å­—æ®µï¼Œç„¶åæŠŠæ•´ä¸ª <code>lept_member</code> å‹å…¥æ ˆï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 3. parse value */</span></span><br><span class="line"><span class="keyword">if</span> ((ret = lept_parse_value(c, &amp;m.v)) != LEPT_PARSE_OK)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="built_in">memcpy</span>(lept_context_push(c, <span class="keyword">sizeof</span>(lept_member)), &amp;m, <span class="keyword">sizeof</span>(lept_member));</span><br><span class="line">size++;</span><br><span class="line">m.k = <span class="literal">NULL</span>; <span class="comment">/* ownership is transferred to member on stack */</span></span><br></pre></td></tr></table></figure>

<p>ä½†æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œå¦‚æœä¹‹å‰ç¼ºä¹å†’å·ï¼Œæˆ–æ˜¯è¿™é‡Œè§£æå€¼å¤±è´¥ï¼Œåœ¨å‡½æ•°è¿”å›å‰æˆ‘ä»¬è¦é‡Šæ”¾ <code>m.k</code>ã€‚å¦‚æœæˆ‘ä»¬æˆåŠŸåœ°è§£ææ•´ä¸ªæˆå‘˜ï¼Œé‚£ä¹ˆå°±è¦æŠŠ <code>m.k</code> è®¾ä¸ºç©ºæŒ‡é’ˆï¼Œå…¶æ„ä¹‰æ˜¯è¯´æ˜è¯¥é”®çš„å­—ç¬¦ä¸²çš„æ‹¥æœ‰æƒå·²è½¬ç§»è‡³æ ˆï¼Œä¹‹åå¦‚é‡åˆ°é”™è¯¯ï¼Œæˆ‘ä»¬ä¸ä¼šé‡è¦†é‡Šæ”¾æ ˆé‡Œæˆå‘˜çš„é”®å’Œè¿™ä¸ªä¸´æ—¶æˆå‘˜çš„é”®ã€‚</p>
<p>ç¬¬ 4 æ­¥ï¼Œè§£æé€—å·æˆ–å³èŠ±æ‹¬å·ã€‚é‡ä¸Šå³èŠ±æ‹¬å·çš„è¯ï¼Œå½“å‰çš„ JSON å¯¹è±¡å°±è§£æå®Œç»“äº†ï¼Œæˆ‘ä»¬æŠŠæ ˆä¸Šçš„æˆå‘˜å¤åˆ¶è‡³ç»“æœï¼Œå¹¶ç›´æ¥è¿”å›ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 4. parse ws [comma | right-curly-brace] ws */</span></span><br><span class="line">lept_parse_whitespace(c);</span><br><span class="line"><span class="keyword">if</span> (*c-&gt;json == <span class="string">&#x27;,&#x27;</span>) &#123;</span><br><span class="line">    c-&gt;json++;</span><br><span class="line">    lept_parse_whitespace(c);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (*c-&gt;json == <span class="string">&#x27;&#125;&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">size_t</span> s = <span class="keyword">sizeof</span>(lept_member) * size;</span><br><span class="line">    c-&gt;json++;</span><br><span class="line">    v-&gt;type = LEPT_OBJECT;</span><br><span class="line">    v-&gt;u.o.size = size;</span><br><span class="line">    <span class="built_in">memcpy</span>(v-&gt;u.o.m = (lept_member*)<span class="built_in">malloc</span>(s), lept_context_pop(c, s), s);</span><br><span class="line">    <span class="keyword">return</span> LEPT_PARSE_OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    ret = LEPT_PARSE_MISS_COMMA_OR_CURLY_BRACKET;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œå½“ <code>for (;;)</code> ä¸­é‡åˆ°ä»»ä½•é”™è¯¯ä¾¿ä¼šåˆ°è¾¾è¿™ç¬¬ 5 æ­¥ï¼Œè¦é‡Šæ”¾ä¸´æ—¶çš„ key å­—ç¬¦ä¸²åŠæ ˆä¸Šçš„æˆå‘˜ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 5. Pop and free members on the stack */</span></span><br><span class="line"><span class="built_in">free</span>(m.k);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">    lept_member* m = (lept_member*)lept_context_pop(c, <span class="keyword">sizeof</span>(lept_member));</span><br><span class="line">    <span class="built_in">free</span>(m-&gt;k);</span><br><span class="line">    lept_free(&amp;m-&gt;v);</span><br><span class="line">&#125;</span><br><span class="line">v-&gt;type = LEPT_NULL;</span><br><span class="line"><span class="keyword">return</span> ret;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„æˆ‘ä»¬ä¸éœ€è¦å…ˆæ£€æŸ¥ <code>m.k != NULL</code>ï¼Œå› ä¸º <code>free(NULL)</code> æ˜¯å®Œå…¨åˆæ³•çš„ã€‚</p>
<ol start="3">
<li>ä½¿ç”¨å·¥å…·æ£€æµ‹å†…å­˜æ³„æ¼ï¼Œè§£å†³å®ƒä»¬ã€‚</li>
</ol>
<p>ä½¿ç”¨å·¥å…·æ£€æµ‹å†…å­˜æ³„æ¼æ—¶ï¼Œæˆ‘ä»¬ä¼šå‘ç°ä»¥ä¸‹è¿™è¡Œä»£ç é€ æˆå†…å­˜æ³„æ¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(v-&gt;u.o.m = (lept_member*)<span class="built_in">malloc</span>(s), lept_context_pop(c, s), s);</span><br></pre></td></tr></table></figure>

<p>ç±»ä¼¼æ•°ç»„ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦åœ¨ <code>lept_free()</code> é‡Šæ”¾ JSON å¯¹è±¡çš„æˆå‘˜ï¼ˆåŒ…æ‹¬é”®åŠå€¼ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lept_free</span><span class="params">(lept_value* v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> i;</span><br><span class="line">    assert(v != <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">switch</span> (v-&gt;type) &#123;</span><br><span class="line">        <span class="comment">/* ... */</span></span><br><span class="line">        <span class="keyword">case</span> LEPT_OBJECT:</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; v-&gt;u.o.size; i++) &#123;</span><br><span class="line">                <span class="built_in">free</span>(v-&gt;u.o.m[i].k);</span><br><span class="line">                lept_free(&amp;v-&gt;u.o.m[i].v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">free</span>(v-&gt;u.o.m);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v-&gt;type = LEPT_NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2021/null/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> ä¸Šä¸€é¡µ</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2021/validation-set-and-test-set/" type="button" class="btn btn-default ">ä¸‹ä¸€é¡µ<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	<!-- 
<section id="comment">
    <h2 class="title">ç•™è¨€</h2>

    
</section>
 -->


    <section id="comment">
        <h2 class="title">
            ç•™è¨€
        </h2>
        <div id="vcomments"></div>
        <script>
            new Valine({
                el: '#vcomments',
                appId: '8FWjWdEoyYxwoFgc2ET6DcSh-gzGzoHsz',
                appKey: 'DqH3LDGq73YqdepEDCcPgWhl',
                visitor: true,
                // avatar: 'hide',
                avatar: 'retro',
                // è¿™é‡Œè®¾ç½®CDN, é»˜è®¤å¾®åšè¡¨æƒ…CDN
                // emojiCDN: 'https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/',
                // // è¡¨æƒ…titleå’Œå›¾ç‰‡æ˜ å°„
                // emojiMaps: {
                //     "smile": "e3/2018new_weixioa02_org.png",
                //     "lovely": "09/2018new_keai_org.png",
                //     // ... æ›´å¤šè¡¨æƒ…
                // }
            })
        </script>
    </section>


    <style type="text/css">
        h2.title {
            font-size: 25px;
            margin-bottom: 27px;
        }

        .v[data-class=v] .vwrap {
            border: 3px solid #f0f0f0;
        }
    
        .v[data-class=v] .vwrap .vheader .vinput {
            border-bottom: 1.8px dashed #f5f5f5;
            color: #bebaba;
            font-size: 17px;
        }

        .v[data-class=v] .veditor {
            font-size: 1.2em;
            color: #b5b5b5;
        }

        .v[data-class=v] .vrow .vcol {
            
            font-size: 17px;
        }

        .v[data-class=v] .vicon {
            fill: #bebebe;
        }

        .v[data-class=v] .vrow {
            font-size: 0;
            padding: 10px 0 0;
        }

        .v[data-class=v] .vbtn {
            color: #d0cdcd;
        }
        
        .v[data-class=v] .vsys {
            padding: 0em 0em;
        }

        .v[data-class=v] .vcards .vcard {
            padding-top: 0em;
        }

        .v[data-class=v] p {
            margin-bottom: 0;
            color: #c0c0c0;
        }

        a:hover {
            font-weight: 800 !important;
        }

        .v[data-class=v] a:hover{
            color: #c66400;
            background: bottom !important;
        }

        .v[data-class=v] a.vnick:hover{
            color: #c66400 !important;
            background: bottom !important;
        }

        .v[data-class=v] .vwrap .vheader .vinput:focus {
            border-bottom-color: #ff7c29;
        }

    </style>





	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2021-08-12 
	</div>
	
	<span id="busuanzi_container_page_pv">
		<i class="fa fa-eye"></i>
  		<span id="busuanzi_value_page_pv"></span>
    </span>

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/é¡¹ç›®/">é¡¹ç›®<span>10</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/json/">json<span>8</span></a></li>
  
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E4%B8%80%E3%80%81JSON-%E5%AF%B9%E8%B1%A1"><span class="toc-article-text">ä¸€ã€JSON å¯¹è±¡</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-article-text">äºŒã€æ•°æ®ç»“æ„</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E4%B8%89%E3%80%81%E9%87%8D%E6%9E%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E6%9E%90"><span class="toc-article-text">ä¸‰ã€é‡æ„å­—ç¬¦ä¸²è§£æ</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E5%9B%9B%E3%80%81%E5%AE%9E%E7%8E%B0"><span class="toc-article-text">å››ã€å®ç°</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E4%BA%94%E3%80%81%E6%80%BB%E7%BB%93%E4%B8%8E%E7%BB%83%E4%B9%A0"><span class="toc-article-text">äº”ã€æ€»ç»“ä¸ç»ƒä¹ </span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2022 AYu
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br>     
     <span id="busuanzi_container_site_pv">
    	ğŸ‘€: <span id="busuanzi_value_site_pv"></span>    |   ğŸ™‹: <span id="busuanzi_value_site_uv"></span>
	</span>
</p>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>â¬†ï¸TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
